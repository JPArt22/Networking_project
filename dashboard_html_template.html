<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestión de Red Universitaria | UNAL</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        :root {
            --unal-green: #28a745;
            --unal-dark: #1a1a1a;
            --danger-red: #dc3545;
            --warning-orange: #fd7e14;
            --info-blue: #0dcaf0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--unal-green) 0%, #1e7e34 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: white !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: var(--unal-green);
            box-shadow: 0 0 8px var(--unal-green);
        }
        
        .status-warning {
            background-color: var(--warning-orange);
            box-shadow: 0 0 8px var(--warning-orange);
        }
        
        .status-error {
            background-color: var(--danger-red);
            box-shadow: 0 0 8px var(--danger-red);
        }
        
        .alert-item {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: white;
            transition: all 0.3s;
        }
        
        .alert-item:hover {
            transform: translateX(5px);
        }
        
        .alert-low { border-left-color: var(--info-blue); }
        .alert-medium { border-left-color: var(--warning-orange); }
        .alert-high { border-left-color: var(--danger-red); }
        .alert-critical { 
            border-left-color: #8b0000; 
            background-color: #fff5f5;
        }
        
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: var(--unal-dark);
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        
        .log-INFO { color: #0dcaf0; }
        .log-WARNING { color: #ffc107; }
        .log-ERROR { color: #dc3545; }
        .log-CRITICAL { 
            color: #ff0000; 
            font-weight: bold;
        }
        
        .vlan-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin: 5px;
        }
        
        .progress-custom {
            height: 25px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-network-wired"></i>
                Dashboard de Gestión de Red - Universidad Nacional de Colombia
            </span>
            <div class="text-white">
                <span id="connection-status" class="me-3">
                    <span class="status-indicator status-active"></span>
                    Conectado
                </span>
                <span id="current-time"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Métricas Principales -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <i class="fas fa-network-wired fa-2x text-primary mb-2"></i>
                        <div class="metric-label">Paquetes Totales</div>
                        <div class="metric-value text-primary" id="total-packets">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-success mb-2"></i>
                        <div class="metric-label">Latencia Promedio</div>
                        <div class="metric-value text-success" id="avg-latency">0 ms</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <i class="fas fa-microchip fa-2x text-warning mb-2"></i>
                        <div class="metric-label">Uso de CPU</div>
                        <div class="metric-value text-warning" id="cpu-usage">0%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <i class="fas fa-memory fa-2x text-danger mb-2"></i>
                        <div class="metric-label">Uso de Memoria</div>
                        <div class="metric-value text-danger" id="memory-usage">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Throughput por VLAN (Mbps)
                    </div>
                    <div class="card-body">
                        <canvas id="throughputChart" height="100"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie"></i> Distribución de Protocolos
                    </div>
                    <div class="card-body">
                        <canvas id="protocolChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- VLANs y Alertas -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sitemap"></i> Estado de VLANs
                    </div>
                    <div class="card-body" id="vlan-status">
                        <p class="text-muted">Cargando información de VLANs...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle"></i> Alertas Recientes
                    </div>
                    <div class="card-body" id="alerts-container" style="height: 300px; overflow-y: auto;">
                        <p class="text-muted">No hay alertas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predicciones y Logs -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-brain"></i> Predicciones de IA
                    </div>
                    <div class="card-body" id="predictions-container">
                        <p class="text-muted">No hay predicciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-terminal"></i> Logs del Sistema
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="logs-container">
                            <div class="log-entry">[INFO] Sistema iniciado...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Conectar a Socket.IO
        const socket = io();
        
        // Variables globales para gráficos
        let throughputChart, protocolChart;
        const throughputData = {
            labels: [],
            datasets: []
        };
        
        // Inicializar gráficos
        function initCharts() {
            // Gráfico de Throughput
            const throughputCtx = document.getElementById('throughputChart').getContext('2d');
            throughputChart = new Chart(throughputCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Throughput (Mbps)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tiempo'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
            
            // Gráfico de Protocolos
            const protocolCtx = document.getElementById('protocolChart').getContext('2d');
            protocolChart = new Chart(protocolCtx, {
                type: 'doughnut',
                data: {
                    labels: ['TCP', 'UDP', 'ICMP', 'Otros'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Actualizar métricas principales
        function updateMainMetrics(metrics) {
            document.getElementById('total-packets').textContent = 
                metrics.total_packets?.toLocaleString() || '0';
            
            document.getElementById('avg-latency').textContent = 
                (metrics.latency?.avg_ms?.toFixed(2) || '0') + ' ms';
            
            document.getElementById('cpu-usage').textContent = 
                (metrics.system?.cpu_percent?.toFixed(1) || '0') + '%';
            
            document.getElementById('memory-usage').textContent = 
                (metrics.system?.memory_percent?.toFixed(1) || '0') + '%';
        }
        
        // Actualizar gráfico de throughput
        function updateThroughputChart(metrics) {
            if (!metrics.vlans) return;
            
            const time = new Date().toLocaleTimeString();
            
            // Añadir timestamp
            if (throughputChart.data.labels.length >= 20) {
                throughputChart.data.labels.shift();
            }
            throughputChart.data.labels.push(time);
            
            // Actualizar datos de cada VLAN
            Object.entries(metrics.vlans).forEach(([vlanId, vlanData]) => {
                let dataset = throughputChart.data.datasets.find(d => d.label === vlanData.name);
                
                if (!dataset) {
                    const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
                    dataset = {
                        label: vlanData.name,
                        data: [],
                        borderColor: colors[throughputChart.data.datasets.length % colors.length],
                        tension: 0.4,
                        fill: false
                    };
                    throughputChart.data.datasets.push(dataset);
                }
                
                if (dataset.data.length >= 20) {
                    dataset.data.shift();
                }
                dataset.data.push(vlanData.throughput_mbps || 0);
            });
            
            throughputChart.update('none');
        }
        
        // Actualizar gráfico de protocolos
        function updateProtocolChart(metrics) {
            if (!metrics.vlans) return;
            
            let tcp = 0, udp = 0, icmp = 0, other = 0;
            let count = 0;
            
            Object.values(metrics.vlans).forEach(vlanData => {
                const dist = vlanData.protocol_distribution || {};
                tcp += dist.TCP || 0;
                udp += dist.UDP || 0;
                icmp += dist.ICMP || 0;
                other += dist.Other || 0;
                count++;
            });
            
            if (count > 0) {
                protocolChart.data.datasets[0].data = [
                    (tcp / count).toFixed(1),
                    (udp / count).toFixed(1),
                    (icmp / count).toFixed(1),
                    (other / count).toFixed(1)
                ];
                protocolChart.update('none');
            }
        }
        
        // Actualizar estado de VLANs
        function updateVLANStatus(metrics) {
            if (!metrics.vlans) return;
            
            const container = document.getElementById('vlan-status');
            let html = '';
            
            Object.entries(metrics.vlans).forEach(([vlanId, vlanData]) => {
                const errorClass = vlanData.error_rate > 5 ? 'danger' : 
                                  vlanData.error_rate > 2 ? 'warning' : 'success';
                
                html += `
                    <div class="mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <span class="vlan-badge bg-primary text-white">VLAN ${vlanId}</span>
                                ${vlanData.name}
                            </h6>
                            <span class="status-indicator status-active"></span>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Throughput:</small>
                                <div><strong>${vlanData.throughput_mbps?.toFixed(2)} Mbps</strong></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Paquetes:</small>
                                <div><strong>${vlanData.packets?.toLocaleString()}</strong></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Error Rate:</small>
                            <div class="progress progress-custom">
                                <div class="progress-bar bg-${errorClass}" 
                                     style="width: ${Math.min(vlanData.error_rate * 10, 100)}%">
                                    ${vlanData.error_rate?.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Añadir alerta
        function addAlert(alert) {
            const container = document.getElementById('alerts-container');
            
            // Limpiar mensaje de "No hay alertas"
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${alert.severity}`;
            alertDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>
                        <i class="fas fa-exclamation-circle"></i>
                        ${alert.severity.toUpperCase()}
                    </strong>
                    <small class="text-muted">${new Date(alert.timestamp).toLocaleTimeString()}</small>
                </div>
                <div class="mt-2">${alert.message}</div>
                ${alert.thresholds_exceeded?.length > 0 ? 
                    `<div class="mt-1"><small class="text-danger">
                        ${alert.thresholds_exceeded.join(', ')}
                    </small></div>` : ''}
                <div class="mt-1"><small>Confianza: ${alert.confidence}%</small></div>
            `;
            
            container.insertBefore(alertDiv, container.firstChild);
            
            // Mantener solo últimas 10 alertas
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
            
            // Animación de entrada
            alertDiv.style.opacity = '0';
            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s';
                alertDiv.style.opacity = '1';
            }, 10);
        }
        
        // Añadir predicción
        function addPrediction(prediction) {
            const container = document.getElementById('predictions-container');
            
            // Limpiar mensaje inicial
            if (container.querySelector('.text-muted')) {
                container.innerHTML = '';
            }
            
            const predDiv = document.createElement('div');
            predDiv.className = `alert-item alert-${prediction.severity} mb-2`;
            predDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>
                        <i class="fas fa-brain"></i>
                        Predicción de Fallo
                    </strong>
                    <small class="text-muted">${new Date(prediction.timestamp).toLocaleTimeString()}</small>
                </div>
                <div class="mt-2">
                    <div class="progress progress-custom">
                        <div class="progress-bar bg-danger" 
                             style="width: ${prediction.failure_probability}%">
                            ${prediction.failure_probability}%
                        </div>
                    </div>
                </div>
                <div class="mt-2">${prediction.message}</div>
                ${prediction.eta ? 
                    `<div class="mt-1"><small><i class="fas fa-clock"></i> 
                        ETA: ${new Date(prediction.eta).toLocaleString()}
                    </small></div>` : ''}
                <div class="mt-1"><small>Confianza: ${prediction.confidence}%</small></div>
            `;
            
            container.insertBefore(predDiv, container.firstChild);
            
            // Mantener solo últimas 5 predicciones
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }
        
        // Añadir log
        function addLog(log) {
            const container = document.getElementById('logs-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${log.level}`;
            
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] [${log.level}] ${log.message}`;
            
            container.appendChild(logEntry);
            
            // Auto-scroll al final
            container.scrollTop = container.scrollHeight;
            
            // Mantener solo últimos 100 logs
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }
        
        // Actualizar reloj
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleString('es-CO');
        }
        
        // Event Listeners de Socket.IO
        socket.on('connect', () => {
            console.log('Conectado al servidor');
            document.getElementById('connection-status').innerHTML = `
                <span class="status-indicator status-active"></span>
                Conectado
            `;
        });
        
        socket.on('disconnect', () => {
            console.log('Desconectado del servidor');
            document.getElementById('connection-status').innerHTML = `
                <span class="status-indicator status-error"></span>
                Desconectado
            `;
        });
        
        socket.on('metrics_update', (metrics) => {
            updateMainMetrics(metrics);
            updateThroughputChart(metrics);
            updateProtocolChart(metrics);
            updateVLANStatus(metrics);
        });
        
        socket.on('anomaly_alert', (alert) => {
            addAlert(alert);
            
            // Notificación del navegador (si está permitida)
            if (Notification.permission === "granted" && alert.severity !== 'low') {
                new Notification('Anomalía Detectada', {
                    body: alert.message,
                    icon: '/static/icon.png'
                });
            }
        });
        
        socket.on('failure_prediction', (prediction) => {
            addPrediction(prediction);
            
            // Notificación crítica
            if (Notification.permission === "granted" && prediction.prediction) {
                new Notification('⚠️ Fallo Predicho', {
                    body: prediction.message,
                    icon: '/static/icon.png',
                    requireInteraction: true
                });
            }
        });
        
        socket.on('new_log', (log) => {
            addLog(log);
        });
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Solicitar permiso para notificaciones
            if (Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Cargar datos iniciales
            fetch('/api/metrics/current')
                .then(r => r.json())
                .then(metrics => {
                    if (Object.keys(metrics).length > 0) {
                        updateMainMetrics(metrics);
                        updateVLANStatus(metrics);
                    }
                });
            
            fetch('/api/alerts')
                .then(r => r.json())
                .then(data => {
                    data.alerts.forEach(alert => addAlert(alert));
                });
            
            fetch('/api/predictions')
                .then(r => r.json())
                .then(data => {
                    data.predictions.forEach(pred => addPrediction(pred));
                });
            
            console.log('Dashboard inicializado correctamente');
        });
    </script>
</body>
</html>